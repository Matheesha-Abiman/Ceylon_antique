<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - Ceylon Antiques</title>
    <link rel="stylesheet" href="../css/spinner.css">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary: #7B68EE;
            --accent: #00BFFF;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #F1F5F9;
            --text-light: #CBD5E1;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1E293B, #0F172A);
            font-family: 'Poppins', sans-serif;
            color: var(--text);
            margin: 0;
        }

        .cart-card {
            position: relative;
            width: 400px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px 20px 20px 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .cancel-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: #FF4D4F;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .cancel-btn:hover {
            transform: scale(1.2);
        }

        .cart-card h2 {
            text-align: center;
            font-size: 1.6rem;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .cart-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s;
        }

        .cart-item:hover {
            transform: translateX(5px);
        }

        .cart-item img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 12px;
            margin-right: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-details h4 {
            font-size: 1rem;
            margin: 0 0 5px;
            color: var(--text);
        }

        .cart-item-details small {
            color: var(--text-light);
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .quantity-control button {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            color: #fff;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .quantity-control button:hover {
            transform: scale(1.1);
        }

        .cart-price {
            font-weight: bold;
            color: #00BFFF;
            margin-left: 10px;
            min-width: 60px;
            text-align: right;
        }

        .delete-btn {
            background: transparent;
            border: none;
            color: #FF4D4F;
            font-size: 1.3rem;
            cursor: pointer;
            margin-left: 10px;
            transition: transform 0.2s;
        }

        .delete-btn:hover {
            transform: scale(1.2);
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1rem;
            font-weight: bold;
            color: var(--text);
        }

        .checkout-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }

        .checkout-btn:hover {
            transform: scale(1.05);
            background: linear-gradient(135deg, var(--accent), var(--primary));
        }

        .cart-card form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            max-height: 80vh;
            padding: 1rem;
        }

        .cart-card .form-group {
            display: flex;
            flex-direction: column;
        }

        .cart-card label {
            margin-bottom: 4px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .cart-card input {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            outline: none;
            transition: border 0.2s, background 0.2s;
        }

        .cart-card input:focus {
            border: 1px solid var(--accent);
            background: rgba(255, 255, 255, 0.1);
        }

        .cart-card form .checkout-btn {
            margin: 15px auto;
            width: 40%;
            /*margin: 0 auto;*/
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1055;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 75%;
            height: auto;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }

    </style>
</head>
<body>

<div class="cart-card" id="cart-card">
    <!-- Close Button -->
    <button class="cancel-btn" onclick="closeCart()">✕</button>

    <h2><i class="bx bx-cart"></i> Shopping Cart</h2>

    <div id="cart-items">
        <!-- Cart items will be dynamically added here -->
    </div>

    <div class="cart-total">
        <span>Subtotal</span>
        <span id="subtotal-price">$0.00</span>
    </div>

    <div class="cart-total">
        <span>Shipping</span>
        <span>$25.00</span>
    </div>

    <div class="cart-total">
        <span>Total</span>
        <span id="total-price">$25.00</span>
    </div>

    <!-- Checkout Button using JS redirect -->
    <button class="checkout-btn" onclick="goToCheckout()">
        <i class='bx bx-credit-card'></i> Proceed to Checkout
    </button>
</div>

<div class="cart-card modal" id="paymentDetails">
    <button class="cancel-btn">&times;</button>
    <h2>Customer Information</h2>
    <form id="customerForm">


        <div class="form-group">
            <label for="first_name">First Name</label>
            <input type="text" id="first_name" name="first_name" placeholder="John" value="John" required>
        </div>

        <div class="form-group">
            <label for="last_name">Last Name</label>
            <input type="text" id="last_name" name="last_name" placeholder="Doe" value="Doe" required>
        </div>

        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" placeholder="john@example.com" value="john@example.com" required>
        </div>

        <div class="form-group">
            <label for="phone">Phone No</label>
            <input type="tel" id="phone" name="phone" placeholder="+94 77 123 4567" value="+94 77 123 4567" required>
        </div>

        <div class="form-group">
            <label for="address">Address</label>
            <input type="text" id="address" name="address" placeholder="Street, City, ZIP" value="Street, City, ZIP" required>
        </div>

        <div class="form-group">
            <label for="city">City</label>
            <input type="text" id="city" name="city" placeholder="Colombo" value="Colombo" required>
        </div>

        <div class="form-group">
            <label for="country">Country</label>
            <input type="text" id="country" name="country" placeholder="Sri Lanka" value="Sri Lanka" required>
        </div>

        <button type="submit" class="checkout-btn">Submit</button>
    </form>
</div>

<script src="../js/common.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script type="text/javascript" src="https://www.payhere.lk/lib/payhere.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<script>
  let products = [];
  let orderDetails;
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  let userData = JSON.parse(sessionStorage.getItem('user')) || [];
  const merchant_id = '1232122';
  const merchant_secret = 'MTk3NzM0NjIxODM1MzQxOTIzNjgzMzkxODI2MjQ5MTk2ODk3ODI1NQ=='
  const API_BASE_URL = 'http://localhost:8080/api/v1';

  function generatePayHereHash(merchant_id, order_id, amount, currency, merchant_secret) {
    // Step 1: hash the secret
    let hashedSecret = CryptoJS.MD5(merchant_secret).toString().toUpperCase();

    // Step 2: format the amount (2 decimals, no commas)
    let amountFormatted = parseFloat(amount)
      .toLocaleString('en-us', {minimumFractionDigits: 2})
      .replace(/,/g, '');

    // Step 3: build the hash string
    let raw = merchant_id + order_id + amountFormatted + currency + hashedSecret;

    // Step 4: hash it again
    return CryptoJS.MD5(raw).toString().toUpperCase();
  }

  document.addEventListener('DOMContentLoaded', async function () {
    await loadProducts();
    // Initialize cart display on page load
    updateCartDisplay();

    // Get the form element
    const customerForm = document.getElementById('customerForm');

    document.querySelector('#paymentDetails .cancel-btn').addEventListener('click', function () {
      customerForm.reset();
      document.getElementById('paymentDetails').style.display = 'none';

    })

    payhere.onCompleted = async function onCompleted(orderId) {
      console.log("Payment completed. OrderID:" + orderId);

      const raw = JSON.stringify({
        "orderDate": "2025-09-21T14:30:00",
        "userId": userData.id,
        "status": "PROCESSING",
        "orderId": orderDetails.order_id,
        "transactionId": orderId,
        "customerName": `${orderDetails.first_name} ${orderDetails.last_name}`,
        "customerEmail": orderDetails.email,
        "phone": orderDetails.phone,
        "address": orderDetails.address,
        "city": orderDetails.delivery_city,
        "country": orderDetails.delivery_country,
        "deliveryAddress": orderDetails.address,
        "deliveryCity": orderDetails.delivery_city,
        "deliveryCountry": orderDetails.delivery_country,
        "totalAmount": orderDetails.amount,
        "currency": orderDetails.currency,
        "productIds": products.map(p => p.id)
      });

      console.log({raw})

      showSuccess("Payment successfully completed.");

      const response = await fetch(`${API_BASE_URL}/orders`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: raw
      });

      console.log(response)

      if (response.ok) {
        showSuccess("Order has been successfully placed.");
        customerForm.reset();
        document.getElementById('paymentDetails').style.display = 'none';
        localStorage.removeItem('cart');
        setTimeout(() => {
          window.location.href = "buyerProfile.html";
        }, 5000)
      } else {
        showError('Error occurred while placing order.');
        customerForm.reset();
        document.getElementById('paymentDetails').style.display = 'none';
      }
    };

    // Payment window closed
    payhere.onDismissed = function onDismissed() {
      // Note: Prompt user to pay again or show an error page
      showError('Payment canceled');
      console.log("Payment dismissed");
    };

    // Error occurred
    payhere.onError = function onError(error) {
      // Note: show an error page
      showError('Error occurred while making the payment.');
      console.log("Error:" + error);
    };

    customerForm.addEventListener('submit', function (e) {
      e.preventDefault(); // Prevent default form submission
      const uuid = generateUUID()
      // Collect form data
      if (!userData && !products) return;
      const payment = {
        "sandbox": true,
        "merchant_id": merchant_id,    // Replace your Merchant ID
        "return_url": undefined,     // Important
        "cancel_url": undefined,     // Important
        "notify_url": "http://sample.com/notify",
        "order_id": uuid,
        "items": uuid,
        "amount": parseFloat(getTotal()),
        "currency": "LKR",
        "hash": generatePayHereHash(merchant_id, uuid, parseFloat(getTotal()), "LKR", merchant_secret), // *Replace with generated hash retrieved from backend
        "first_name": this.first_name.value,
        "last_name": this.last_name.value,
        "email": this.email.value,
        "phone": this.phone.value,
        "address": this.address.value,
        "city": this.city.value,
        "country": this.country.value,
        "delivery_address": this.address.value,
        "delivery_city": this.city.value,
        "delivery_country": this.country.value,
        "custom_1": "",
        "custom_2": ""
      };

      orderDetails = payment;
      console.log("Customer Info Submitted:", payment);

      payhere.startPayment(payment)

    });

  })

  // Retrieve cart data from localStorage


  async function loadProducts() {
    try {
      const ids = cart.map(c => Number(c.id))
      showLoading('#cart-items');
      console.log({cart, ids}, ids.join(','))
      const response = await fetch(`${API_BASE_URL}/product/by-ids?ids=${ids.join(',')}`);
      console.log({response})
      if (!response.ok) {
        if (response.status === 403) {
          throw new Error('Access forbidden. Check your security configuration.');
        }
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      products = await response.json();
    } catch (error) {
      console.error('Error loading products:', error);
      showError(`Error loading products: ${error.message}`);
    }
  }

  function updateCartDisplay() {
    const cartItems = document.getElementById('cart-items');
    const subtotalPrice = document.getElementById('subtotal-price');
    const totalPrice = document.getElementById('total-price');

    cartItems.innerHTML = '';
    let subtotal = 0;

    if (cart.length === 0) {
      cartItems.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-light);">Your cart is empty</p>';
      subtotalPrice.textContent = '$0.00';
      totalPrice.textContent = '$0.00';
      return;
    }

    cart.forEach((item, index) => {
      const product = products.find(p => p.id === item.id);
      if (!product) return;
      if (item.qty > product.stock) {
        deleteItem(index);
      }
      const itemTotal = product.price * item.qty;
      subtotal += itemTotal;

      const cartItem = document.createElement('div');
      cartItem.classList.add('cart-item');
      cartItem.innerHTML = `
                <img
                src="${product.imageUrl || 'https://placehold.co/400'}"
                alt="${product.productName || 'Product'}"
                onerror="this.src='https://placehold.co/400'"
                style=" width: 70px; height: 70px; object-fit: cover; background-position: center; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                <div class="cart-item-details">
                    <h4>${item.name}</h4>
                    <small>Quantity: <span class="quantity">${item.qty} / ${product.stock} available</span></small>
                    <div class="quantity-control">
                        <button onclick="changeQuantity(${index}, -1)">-</button>
                        <button onclick="changeQuantity(${index}, 1)">+</button>
                    </div>
                </div>
                <span class="cart-price">$${(itemTotal).toFixed(2)}</span>
                <button class="delete-btn" onclick="deleteItem(${index})">✕</button>
            `;
      cartItems.appendChild(cartItem);
    });

    subtotalPrice.textContent = `$${subtotal.toFixed(2)}`;
    totalPrice.textContent = `$${(subtotal + 25).toFixed(2)}`;
  }

  function changeQuantity(index, change) {
    cart[index].qty += change;
    if (cart[index].qty < 1) cart[index].qty = 1;
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartDisplay();
  }

  function deleteItem(index) {
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartDisplay();
  }

  function closeCart() {
    window.location.href = "buyerHome.html";
  }

  function getTotal() {
    let totalPrice = 0
    cart.forEach((item, index) => {
      const product = products.find(p => p.id === item.id);
      if (!product) return;
      if (item.qty > product.stock) {
        return;
      }
      const itemTotal = product.price * item.qty;
      totalPrice += itemTotal;

    });
    return totalPrice;
  }

  function showSuccess(message) {
    Swal.fire({
      icon: 'success',
      title: 'Success',
      text: message,
      timer: 2000,
      showConfirmButton: false
    });
  }

  function showError(message) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: message,
      timer: 3000
    });
  }

  function goToCheckout() {
    if (cart.length > 0) {
      document.getElementById('paymentDetails').style.display = 'block';
    } else {
      alert('Your cart is empty!');
    }
  }


</script>
</body>
</html>